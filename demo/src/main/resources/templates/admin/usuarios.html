<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" th:href="@{/css/style.css}" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <title>Panel de Administración</title>
    <style>
        /* Reset y estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
        }

        /* Container principal */
        .container {
            display: flex;
            min-height: calc(100vh - 80px);
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 2rem 0;
        }

        .sidebar-item {
            display: block;
            padding: 1rem 2rem;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .sidebar-item:hover {
            background: #34495e;
            color: white;
            border-left-color: #3498db;
        }

        .sidebar-item.active {
            background: #34495e;
            color: white;
            border-left-color: #3498db;
            font-weight: 600;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            background: white;
            margin: 1rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #ecf0f1;
        }

        /* Toolbar */
        .toolbar {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .toggle-filters {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-filters:hover {
            background: #5a6268;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        /* Form Containers */
        .form-container {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .form-container h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #ecf0f1;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* Advanced Filters */
        .advanced-filters {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: none;
        }

        .advanced-filters.active {
            display: block;
        }

        .filter-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #34495e;
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Power BI Container */
        .powerbi-container {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .powerbi-container iframe {
            border: none;
            border-radius: 4px;
        }

        /* Checkbox label */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                padding: 1rem 0;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .search-input {
                min-width: auto;
            }

            .filter-row {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <h1>Panel de Administración</h1>
    </header>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <a href="#dashboard" class="sidebar-item active">Dashboard</a>
            <a href="#usuarios" class="sidebar-item">Usuarios</a>
            <a href="#promociones" class="sidebar-item">Promociones</a>
            <a href="#estadisticas" class="sidebar-item">Estadisticas</a>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" style="display: none">
                <h2 class="section-title">Dashboard</h2>

                <!-- Dashboard de Power BI Integrado -->
                <div class="powerbi-container">
                    <iframe title="Dashboard reporte" width="1000" height="1000"
                        src="https://app.powerbi.com/view?r=eyJrIjoiZDQ1NmQ1NzYtM2IyYi00ZjdlLWFjZDEtMmViMGVjNWVjYjJkIiwidCI6ImM0YTY2YzM0LTJiYjctNDUxZi04YmUxLWIyYzI2YTQzMDE1OCIsImMiOjR9"
                        frameborder="0" allowfullscreen="true"></iframe>
                </div>
            </section>

            <!-- Usuarios Section -->
            <section id="usuarios-section" style="display: none">
                <h2 class="section-title">Gestión de Usuarios</h2>


                <div class="toolbar">
                    <input
                            type="text"
                            class="search-input"
                            id="search-users"
                            placeholder="Buscar usuarios..."
                    />
                    <button class="toggle-filters" id="toggle-filters">Filtros Avanzados</button>

                    <div class="action-buttons">
                        <button class="btn btn-small btn-danger btn-delete" id="toggle-delete">
                            Eliminar
                        </button>
                        <button class="btn btn-small btn-primary btn-update" id="toggle-update">
                            Actualizar
                        </button>
                    </div>
                </div>

                <!-- FORMULARIO ELIMINAR -->
                <div class="form-container" id="delete-form">
                    <h3>Eliminar Usuario</h3>
                    <div class="form-group">
                        <label for="delete-id">ID del Usuario</label>
                        <input
                                type="text"
                                id="delete-id"
                                class="form-input"
                                placeholder="Ej: 123"
                        />
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancel-delete">Cancelar</button>
                        <button class="btn btn-danger">Eliminar</button>
                    </div>
                </div>

                <!-- FORMULARIO ACTUALIZAR -->
                <div class="form-container" id="update-form">
                    <h3>Actualizar Usuario</h3>
                    <input type="hidden" id="update-id">

                    <div class="form-group">
                        <label for="update-nombres">Nombres</label>
                        <input type="text" id="update-nombres" class="form-input" placeholder="Ej: Juan Carlos">

                        <label for="update-apellidos">Apellidos</label>
                        <input type="text" id="update-apellidos" class="form-input" placeholder="Ej: Pérez García">

                        <label for="update-email">Email</label>
                        <input type="email" id="update-email" class="form-input" placeholder="Ej: juan@email.com">

                        <label for="update-telefono">Teléfono</label>
                        <input type="text" id="update-telefono" class="form-input" placeholder="Ej: +51 987654321">

                        <label for="update-rol">Rol</label>
                        <select id="update-rol" class="form-input">
                            <option value="ADMIN">Administrador</option>
                            <option value="USER">Usuario</option>
                            <option value="MODERATOR">Moderador</option>
                        </select>

                        <label for="update-activo" class="checkbox-label">
                            <input type="checkbox" id="update-activo"> Usuario activo
                        </label>
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancel-update">Cancelar</button>
                        <button class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </div>

                <!-- FILTROS AVANZADOS -->
                <div class="advanced-filters" id="advanced-filters">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="form-label">Fecha de Registro Desde</label>
                            <input type="date" class="form-input" id="filter-date-from" />
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Fecha de Registro Hasta</label>
                            <input type="date" class="form-input" id="filter-date-to" />
                        </div>
                    </div>
                    <div class="filter-row">
                        <div class="filter-group">
                            <label class="form-label">Ordenar por</label>
                            <select class="form-select" id="filter-sort">
                                <option value="name">Nombre</option>
                                <option value="date">Fecha de Registro</option>
                                <option value="id">ID</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="form-label">Orden</label>
                            <select class="form-select" id="filter-order">
                                <option value="asc">Ascendente</option>
                                <option value="desc">Descendente</option>
                            </select>
                        </div>
                    </div>
                    <div class="filter-actions">
                        <button class="btn" id="clear-filters">Limpiar Filtros</button>
                        <button class="btn btn-primary" id="apply-filters">Aplicar Filtros</button>
                    </div>
                </div>


                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Fecha Registro</th>
                                <th>Estado</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr data-id="001" data-name="Juan Perez" data-email="juan.perez@email.com"
                                data-date="2025-01-15" data-status="Activo" data-role="Usuario">
                                <td>001</td>
                                <td>Juan Perez</td>
                                <td>juan.perez@email.com</td>
                                <td>2025-01-15</td>
                                <td>Activo</td>
                                <td>Usuario</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Promociones Section -->
            <section id="promociones-section" style="display: none">
                <h2 class="section-title">Gestión de Promociones</h2>

                <div class="toolbar">
                    <button class="btn btn-primary">Nueva Promocion</button>
                    <input type="text" class="search-input" id="search-users" placeholder="Buscar promocion...">
                    <select class="select-filter">
                        <option>Todas las promociones</option>
                        <option>Activas</option>
                        <option>Programadas</option>
                        <option>Vencidas</option>
                    </select>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Descuento</th>
                                <th>Fecha Inicio</th>
                                <th>Fecha Fin</th>
                                <th>Estado</th>
                                <th>Uso</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </section>

            <!-- Estadisticas Section -->
            <section id="estadisticas-section" style="display: none">
                <h2 class="section-title">Estadísticas del Sistema - Power BI</h2>

                <!-- Dashboard de Power BI Integrado -->
                <div class="powerbi-container">
                    <iframe title="Prueba" width="1000" height="1000"
                        src="https://app.powerbi.com/view?r=eyJrIjoiYTIzNzFiMjItZmMzMi00M2FhLWFiMDktN2UzMTJhMTNmNDM0IiwidCI6ImM0YTY2YzM0LTJiYjctNDUxZi04YmUxLWIyYzI2YTQzMDE1OCIsImMiOjR9"
                        frameborder="0" allowfullscreen="true"></iframe>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal para editar usuario -->
    <div class="modal" id="edit-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Usuario</h3>
                <button class="close-modal">&times;</button>
            </div>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id" />
                <div class="form-group">
                    <label class="form-label" for="edit-user-name">Nombre</label>
                    <input type="text" class="form-input" id="edit-user-name" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-user-email">Email</label>
                    <input type="email" class="form-input" id="edit-user-email" required />
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-user-status">Estado</label>
                    <select class="form-select" id="edit-user-status" required>
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                        <option value="Bloqueado">Bloqueado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="edit-user-role">Rol</label>
                    <select class="form-select" id="edit-user-role" required>
                        <option value="Usuario">Usuario</option>
                        <option value="Administrador">Administrador</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn close-modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmación para eliminar usuario -->
    <div class="modal confirmation-modal" id="delete-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Confirmar Eliminación</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="confirmation-text">
                <p>
                    ¿Está seguro de que desea eliminar al usuario
                    <strong id="delete-user-name"></strong>?
                </p>
                <p>Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button class="btn close-modal">Cancelar</button>
                <button class="btn btn-danger" id="confirm-delete">Eliminar</button>
            </div>
        </div>
    </div>

    <script>

        document.addEventListener('DOMContentLoaded', function() {
            // ... (código anterior para mostrar/ocultar formularios) ...

            // Eliminar usuario - URL CORREGIDA
            deleteForm.querySelector('.btn-danger').addEventListener('click', async () => {
                const userId = document.getElementById('delete-id').value;

                if (!userId) {
                    alert('Por favor ingresa un ID de usuario');
                    return;
                }

                if (!confirm('¿Estás seguro de que deseas desactivar este usuario?')) {
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:8081/vistadmin/${userId}`, { // ← URL CORREGIDA
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Usuario desactivado correctamente');
                        deleteForm.style.display = 'none';
                        document.getElementById('delete-id').value = '';
                        window.location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error al eliminar usuario: ' + error.message);
                }
            });

            // Cargar datos del usuario para actualizar - URL CORREGIDA
            document.getElementById('toggle-update').addEventListener('click', async () => {
                const userId = prompt('Ingresa el ID del usuario a actualizar:');
                if (!userId) return;

                try {
                    const response = await fetch(`http://localhost:8081/vistadmin/${userId}/datos`); // ← URL CORREGIDA
                    const result = await response.json();

                    if (result.success) {
                        const usuario = result.usuario;
                        document.getElementById('update-id').value = usuario.id;
                        document.getElementById('update-nombres').value = usuario.nombres || '';
                        document.getElementById('update-apellidos').value = usuario.apellidos || '';
                        document.getElementById('update-email').value = usuario.email || '';
                        document.getElementById('update-telefono').value = usuario.telefono || '';
                        document.getElementById('update-rol').value = usuario.rol || 'USER';
                        document.getElementById('update-activo').checked = usuario.activo;

                        updateForm.style.display = 'block';
                        deleteForm.style.display = 'none';
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error al cargar datos del usuario: ' + error.message);
                }
            });

            // Actualizar usuario - URL CORREGIDA
            updateForm.querySelector('.btn-primary').addEventListener('click', async () => {
                const userId = document.getElementById('update-id').value;
                const nombres = document.getElementById('update-nombres').value;
                const apellidos = document.getElementById('update-apellidos').value;
                const email = document.getElementById('update-email').value;
                const telefono = document.getElementById('update-telefono').value;
                const rol = document.getElementById('update-rol').value;
                const activo = document.getElementById('update-activo').checked;

                if (!userId) {
                    alert('ID de usuario no válido');
                    return;
                }

                try {
                    const params = new URLSearchParams({
                        nombres: nombres || '',
                        apellidos: apellidos || '',
                        email: email || '',
                        telefono: telefono || '',
                        rol: rol || '',
                        activo: activo
                    });

                    const response = await fetch(`http://localhost:8081/vistadmin/${userId}?${params}`, { // ← URL CORREGIDA
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Usuario actualizado correctamente');
                        updateForm.style.display = 'none';
                        window.location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error al actualizar usuario: ' + error.message);
                }
            });

            // Búsqueda - URL CORREGIDA
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value;
                if (searchTerm.length >= 3 || searchTerm.length === 0) {
                    window.location.href = `http://localhost:8081/vistadmin?search=${encodeURIComponent(searchTerm)}`; // ← URL CORREGIDA
                }
            });
        });

        // Navegación entre secciones
        document.querySelectorAll(".sidebar-item").forEach((item) => {
            item.addEventListener("click", function (e) {
                e.preventDefault();

                // Actualizar sidebar activo
                document
                    .querySelectorAll(".sidebar-item")
                    .forEach((i) => i.classList.remove("active"));
                this.classList.add("active");

                // Ocultar todas las secciones
                document.querySelectorAll("section").forEach((section) => {
                    section.style.display = "none";
                });

                // Mostrar sección correspondiente
                const target = this.getAttribute("href").substring(1);
                document.getElementById(`${target}-section`).style.display = "block";
            });
        });

        // Funcionalidad de filtros avanzados
            const toggleFiltersBtn = document.getElementById("toggle-filters");
            const advancedFilters = document.getElementById("advanced-filters");
            const deleteBtn = document.getElementById("toggle-delete");
            const updateBtn = document.getElementById("toggle-update");
            const deleteForm = document.getElementById("delete-form");
            const updateForm = document.getElementById("update-form");
            const cancelDelete = document.getElementById("cancel-delete");
            const cancelUpdate = document.getElementById("cancel-update");

            function closeAll() {
            advancedFilters.classList.remove("active");
            deleteForm.classList.remove("active");
            updateForm.classList.remove("active");
            toggleFiltersBtn.textContent = "Filtros Avanzados";
        }

            toggleFiltersBtn.addEventListener("click", function () {
            const isActive = advancedFilters.classList.toggle("active");
            deleteForm.classList.remove("active");
            updateForm.classList.remove("active");
            this.textContent = isActive ? "Ocultar Filtros" : "Filtros Avanzados";
        });

            deleteBtn.addEventListener("click", function () {
            const isActive = deleteForm.classList.toggle("active");
            advancedFilters.classList.remove("active");
            updateForm.classList.remove("active");
            toggleFiltersBtn.textContent = "Filtros Avanzados";
            if (!isActive) closeAll();
        });

            updateBtn.addEventListener("click", function () {
            const isActive = updateForm.classList.toggle("active");
            advancedFilters.classList.remove("active");
            deleteForm.classList.remove("active");
            toggleFiltersBtn.textContent = "Filtros Avanzados";
            if (!isActive) closeAll();
        });

            cancelDelete.addEventListener("click", closeAll);
            cancelUpdate.addEventListener("click", closeAll);

        // Cerrar modales
        document.querySelectorAll(".close-modal").forEach((btn) => {
            btn.addEventListener("click", function () {
                this.closest(".modal").classList.remove("active");
            });
        });

        // Cerrar modal al hacer clic fuera del contenido
        document.querySelectorAll(".modal").forEach((modal) => {
            modal.addEventListener("click", function (e) {
                if (e.target === this) {
                    this.classList.remove("active");
                }
            });
        });
    </script>
</body>

</html>